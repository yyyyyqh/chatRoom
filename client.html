<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket 聊天室</title>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
      }
      #chat-box {
        flex-grow: 1;
        border: 1px solid #ccc;
        margin: 10px;
        padding: 10px;
        overflow-y: auto;
      }
      #chat-box p {
        margin: 5px 0;
      }
      #input-area {
        display: flex;
        padding: 10px;
      }
      #message-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        padding: 8px;
      }
      #send-button {
        border: 1px solid #007bff;
        background-color: #007bff;
        color: white;
        padding: 8px 15px;
        margin-left: 10px;
        cursor: pointer;
      }
      #send-button:hover {
        background-color: #0056b3;
      }
      .server-message {
        color: #888;
        font-style: italic;
      }
      .sent-message {
        text-align: right;
        color: #0056b3;
      }
      .received-message {
        text-align: left;
      }

      #typing-indicator {
        height: 20px;
        padding: 0 10px;
        font-style: italic;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div id="chat-box"></div>
    <div id="typing-indicator"></div>
    <div id="input-area">
      <input
        type="text"
        id="message-input"
        placeholder="输入消息..."
        autocomplete="off"
      />
      <button id="send-button">发送</button>
    </div>

    <script>
      const socket = new WebSocket("ws://localhost:8080");

      const chatBox = document.getElementById("chat-box");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const typingIndicatorDiv = document.getElementById("typing-indicator");

      const MAX_MESSAGES = 50;
      const DELETE_BATCH_SIZE = 10;
      let typingTimer = null;
      let myUsername = null;

      function displayMessage(message, type) {
        const p = document.createElement("p");
        p.textContent = message;
        p.className = type + "-message";
        chatBox.appendChild(p);

        if (chatBox.children.length > MAX_MESSAGES) {
          for (let i = 0; i < DELETE_BATCH_SIZE && chatBox.firstChild; i++) {
            chatBox.removeChild(chatBox.firstChild);
          }
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function sendTypingState(isTyping) {
        if (socket.readyState !== WebSocket.OPEN) return;
        const stateMessage = {
          type: isTyping ? "TYPING_START" : "TYPING_STOP",
        };
        socket.send(JSON.stringify(stateMessage));
      }

      function sendMessage() {
        const messageContent = messageInput.value;
        if (messageContent.trim() === "") {
          return;
        }

        const chatMessage = { type: "CHAT", message: messageContent };
        socket.send(JSON.stringify(chatMessage));
        displayMessage(`我: ${messageContent}`, "sent");
        messageInput.value = "";

        clearTimeout(typingTimer);
        sendTypingState(false);
      }

      socket.onopen = function (event) {
        console.log("WebSocket connection established.");
      };

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const { type, sender, message } = data;

        switch (type) {
          case "SYSTEM":
            if (message.startsWith("欢迎 ")) {
              const parts = message.split(" ");
              if (parts.length > 1) {
                myUsername = parts[1];
                console.log("My username is set to:", myUsername);
              }
            }
            displayMessage(message, "server");
            break;
          case "CHAT":
            if (sender !== myUsername) {
              const formattedMessage = `${sender}: ${message}`;
              displayMessage(formattedMessage, "received");
            }
            break;
          case "TYPING_START":
            if (sender !== myUsername) {
              typingIndicatorDiv.textContent = `${sender} 正在输入...`;
            }
            break;
          case "TYPING_STOP":
            if (typingIndicatorDiv.textContent.startsWith(sender)) {
              typingIndicatorDiv.textContent = "";
            }
            break;
        }
      };

      socket.onclose = function (event) {
        displayMessage("您已从聊天室断开连接。", "server");
      };

      socket.onerror = function (error) {
        displayMessage("连接发生错误。", "server");
        console.error("WebSocket Error:", error);
      };

      sendButton.addEventListener("click", sendMessage);

      messageInput.addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      });

      messageInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        sendTypingState(true);
        typingTimer = setTimeout(() => {
          sendTypingState(false);
        }, 1500);
      });
    </script>
  </body>
</html>
