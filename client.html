<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket 聊天室</title>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
      }
      #chat-box {
        flex-grow: 1;
        border: 1px solid #ccc;
        margin: 10px;
        padding: 10px;
        overflow-y: auto;
      }
      #chat-box p {
        margin: 5px 0;
      }
      #input-area {
        display: flex;
        padding: 10px;
      }
      #message-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        padding: 8px;
      }
      #send-button {
        border: 1px solid #007bff;
        background-color: #007bff;
        color: white;
        padding: 8px 15px;
        margin-left: 10px;
        cursor: pointer;
      }
      #send-button:hover {
        background-color: #0056b3;
      }
      .server-message {
        color: #888;
        font-style: italic;
        text-align: center;
      }
      .sent-message {
        text-align: right;
        color: #0056b3;
      }
      .received-message {
        text-align: left;
      }
      #typing-indicator {
        height: 20px;
        padding: 0 15px;
        font-style: italic;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div id="chat-box"></div>
    <div id="typing-indicator"></div>
    <div id="input-area">
      <input
        type="text"
        id="message-input"
        placeholder="输入消息..."
        autocomplete="off"
      />
      <button id="send-button">发送</button>
    </div>

    <script>
      const socket = new WebSocket("ws://localhost:8080");

      const chatBox = document.getElementById("chat-box");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const typingIndicatorDiv = document.getElementById("typing-indicator");

      const MAX_MESSAGES = 100;
      const DELETE_BATCH_SIZE = 20;
      let typingTimer = null;
      let myUsername = null;
      const typingUsers = new Set();

      function displayMessage(message, type) {
        const p = document.createElement("p");
        p.textContent = message;
        p.className = type + "-message";
        chatBox.appendChild(p);

        if (chatBox.children.length > MAX_MESSAGES) {
          for (let i = 0; i < DELETE_BATCH_SIZE && chatBox.firstChild; i++) {
            chatBox.removeChild(chatBox.firstChild);
          }
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function updateTypingIndicator() {
        const users = Array.from(typingUsers);
        if (users.length === 0) {
          typingIndicatorDiv.textContent = "";
          return;
        }
        if (users.length === 1) {
          typingIndicatorDiv.textContent = `${users[0]} 正在输入...`;
          return;
        }
        if (users.length <= 3) {
          typingIndicatorDiv.textContent = `${users.join("、")} 正在输入...`;
          return;
        }
        typingIndicatorDiv.textContent = `${users
          .slice(0, 2)
          .join("、")} 及其他 ${users.length - 2} 人正在输入...`;
      }

      function sendTypingState(isTyping) {
        if (socket.readyState !== WebSocket.OPEN) return;
        socket.send(
          JSON.stringify({ type: isTyping ? "TYPING_START" : "TYPING_STOP" })
        );
      }

      function sendMessage() {
        const messageContent = messageInput.value;
        if (messageContent.trim() === "" || !myUsername) return;

        socket.send(JSON.stringify({ type: "CHAT", message: messageContent }));
        displayMessage(`我: ${messageContent}`, "sent");
        messageInput.value = "";

        clearTimeout(typingTimer);
        sendTypingState(false);
      }

      socket.onopen = function (event) {
        console.log(
          "WebSocket connection established. Please set your nickname."
        );
        const nickname = prompt(
          "请输入您的昵称 (2-15个字符):",
          `访客${Math.floor(1000 + Math.random() * 9000)}`
        );
        if (nickname) {
          socket.send(
            JSON.stringify({ type: "SET_NICKNAME", nickname: nickname })
          );
        }
      };

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const { type, sender, message, nickname } = data;

        switch (type) {
          case "SYSTEM":
            if (nickname) {
              myUsername = nickname;
              console.log("My username is set to:", myUsername);
            }
            displayMessage(message, "server");
            break;
          case "CHAT":
            typingUsers.delete(sender);
            updateTypingIndicator();
            if (sender !== myUsername) {
              const formattedMessage = `${sender}: ${message}`;
              displayMessage(formattedMessage, "received");
            }
            break;
          case "TYPING_START":
            if (sender !== myUsername) {
              typingUsers.add(sender);
              updateTypingIndicator();
            }
            break;
          case "TYPING_STOP":
            typingUsers.delete(sender);
            updateTypingIndicator();
            break;
        }
      };

      socket.onclose = function (event) {
        displayMessage("您已从聊天室断开连接。", "server");
      };

      socket.onerror = function (error) {
        displayMessage("连接发生错误。", "server");
        console.error("WebSocket Error:", error);
      };

      sendButton.addEventListener("click", sendMessage);

      messageInput.addEventListener("keyup", function (event) {
        if (event.key === "Enter") sendMessage();
      });

      messageInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        if (myUsername) {
          sendTypingState(true);
          typingTimer = setTimeout(() => {
            sendTypingState(false);
          }, 1500);
        }
      });
    </script>
  </body>
</html>
